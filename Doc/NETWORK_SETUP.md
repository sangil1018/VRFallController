# 네트워크 구성 가이드

VR 추락 시뮬레이터 컨트롤러 시스템의 로컬 네트워크 설정 가이드입니다.

## 📋 목차

1. [네트워크 개요](#네트워크-개요)
2. [필요 장비](#필요-장비)
3. [네트워크 구성도](#네트워크-구성도)
4. [PC 설정](#1-pc-설정)
5. [피코4 디바이스 설정](#2-피코4-디바이스-설정)
6. [시뮬레이터 설정](#3-시뮬레이터-설정)
7. [연결 테스트](#4-연결-테스트)
8. [문제 해결](#문제-해결)

---

## 네트워크 개요

모든 장비는 **같은 로컬 네트워크(LAN)**에 연결되어야 합니다.

### 권장 네트워크 구성
- **네트워크 대역**: 192.168.1.x
- **서브넷 마스크**: 255.255.255.0
- **라우터/공유기**: 필수

---

## 필요 장비

| 장비 | 수량 | 용도 |
|------|------|------|
| PC (컨트롤러) | 1대 | 웹 컨트롤 앱 실행 |
| 피코4 VR 헤드셋 | 3대 | VR 안전 체험 콘텐츠 |
| 시뮬레이터 | 1대 | 물리적 추락 시뮬레이터 |
| 공유기/라우터 | 1대 | 네트워크 구성 |
| LAN 케이블 | 필요시 | 유선 연결 (권장) |

---

## 네트워크 구성도

```
┌─────────────────────────────────────────┐
│         공유기 (192.168.1.1)             │
└──────┬──────┬──────┬──────┬─────────────┘
       │      │      │      │
       ├──────┼──────┼──────┤
       ↓      ↓      ↓      ↓
    ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐
    │  PC  │ │Pico#1│ │Pico#2│ │Pico#3│
    │.1.100│ │.1.101│ │.1.102│ │.1.103│
    └──────┘ └──────┘ └──────┘ └──────┘
       │
       ↓
    ┌──────────┐
    │시뮬레이터 │
    │ .1.200   │
    └──────────┘
```

### 권장 IP 주소 배정

| 장비 | IP 주소 | 설명 |
|------|---------|------|
| PC (컨트롤러) | 192.168.1.100 | 고정 IP 권장 |
| 피코4 #1 | 192.168.1.101 | 고정 IP 필수 |
| 피코4 #2 | 192.168.1.102 | 고정 IP 필수 |
| 피코4 #3 | 192.168.1.103 | 고정 IP 필수 |
| 시뮬레이터 | 192.168.1.200 | 고정 IP 권장 |

> [!IMPORTANT]
> 피코4 디바이스는 **반드시 고정 IP**를 설정해야 ADB 연결이 안정적입니다.

---

## 1. PC 설정

### 1-1. 네트워크 어댑터 설정

**Windows 10/11 기준:**

1. **설정** → **네트워크 및 인터넷** → **이더넷** (또는 Wi-Fi)
2. **IP 설정** → **편집** 클릭
3. **수동** 선택 후 다음 값 입력:

```
IP 주소: 192.168.1.100
서브넷 마스크: 255.255.255.0
기본 게이트웨이: 192.168.1.1
기본 설정 DNS: 8.8.8.8
보조 DNS: 8.8.4.4
```

4. **저장** 클릭

### 1-2. 방화벽 설정

컨트롤러 앱이 사용하는 포트를 허용해야 합니다:

**Windows Defender 방화벽:**

1. **Windows 보안** → **방화벽 및 네트워크 보호**
2. **고급 설정** 클릭
3. **인바운드 규칙** → **새 규칙**
4. 다음 포트 허용:
   - **TCP 8000** - 웹 인터페이스
   - **TCP 9100** - Unity 클라이언트 통신

**빠른 설정 (PowerShell 관리자 권한):**

```powershell
New-NetFirewallRule -DisplayName "VR Controller Web" -Direction Inbound -Protocol TCP -LocalPort 8000 -Action Allow
New-NetFirewallRule -DisplayName "VR Controller Unity" -Direction Inbound -Protocol TCP -LocalPort 9100 -Action Allow
```

### 1-3. ADB 설치

1. **Android SDK Platform Tools** 다운로드:
   - https://developer.android.com/studio/releases/platform-tools

2. 압축 해제 후 **환경 변수** 설정:
   - `시스템 속성` → `환경 변수` → `Path`에 추가
   - 예: `C:\platform-tools`

3. **확인**:
   ```cmd
   adb version
   ```

---

## 2. 피코4 디바이스 설정

각 피코4 디바이스마다 아래 설정을 반복합니다.

### 2-1. Wi-Fi 고정 IP 설정

1. **설정** 앱 실행
2. **Wi-Fi** → 연결된 네트워크 이름 **길게 누르기**
3. **네트워크 수정** 선택
4. **고급 옵션 표시** 체크
5. **IP 설정** → **고정** 선택
6. 다음 값 입력:

**피코4 #1:**
```
IP 주소: 192.168.1.101
게이트웨이: 192.168.1.1
네트워크 접두사 길이: 24
DNS 1: 8.8.8.8
DNS 2: 8.8.4.4
```

**피코4 #2:**
```
IP 주소: 192.168.1.102
(나머지 동일)
```

**피코4 #3:**
```
IP 주소: 192.168.1.103
(나머지 동일)
```

7. **저장** 클릭

### 2-2. 개발자 모드 활성화

1. **설정** → **일반** → **정보**
2. **소프트웨어 버전** 7번 연속 탭
3. **개발자 모드** 활성화됨

### 2-3. ADB over Network 활성화

1. **설정** → **시스템** → **개발자**
2. **USB 디버깅** 활성화
3. **무선 디버깅** 활성화 (있는 경우)

### 2-4. PC에서 ADB 연결

각 디바이스마다:

```cmd
adb connect 192.168.1.101
adb connect 192.168.1.102
adb connect 192.168.1.103
```

**확인:**
```cmd
adb devices
```

출력 예시:
```
List of devices attached
192.168.1.101:5555      device
192.168.1.102:5555      device
192.168.1.103:5555      device
```

> [!TIP]
> 피코4를 재부팅하면 ADB 연결이 끊어집니다. 다시 `adb connect` 명령을 실행하세요.

---

## 3. 시뮬레이터 설정

시뮬레이터의 IP 주소를 설정합니다. (장비에 따라 방법이 다를 수 있음)

### 3-1. 네트워크 설정

시뮬레이터 장비의 네트워크 설정에서:

```
IP 주소: 192.168.1.200
서브넷 마스크: 255.255.255.0
게이트웨이: 192.168.1.1
DNS: 8.8.8.8
```

### 3-2. 통신 프로토콜 확인

시뮬레이터 제조사 매뉴얼을 확인하여:
- **통신 방식**: TCP/UDP/Serial
- **포트 번호**: 기본값 또는 설정값
- **프로토콜 형식**: JSON/Binary/Text

현재 컨트롤러 앱 설정 (`config.py`):
```python
SIMULATOR_HOST = "192.168.1.200"
SIMULATOR_PORT = 9000
```

필요시 수정하세요.

---

## 4. 연결 테스트

모든 설정 완료 후 연결을 테스트합니다.

### 4-1. PC 네트워크 연결 확인

```cmd
ping 192.168.1.1
ping 192.168.1.101
ping 192.168.1.102
ping 192.168.1.103
ping 192.168.1.200
```

모두 응답이 와야 합니다.

### 4-2. ADB 연결 테스트

```cmd
adb devices
```

3대 모두 `device` 상태여야 합니다.

### 4-3. 컨트롤러 앱 테스트

1. **테스트 모드로 서버 실행:**
   ```cmd
   start_test.bat
   ```

2. **브라우저에서 접속:**
   ```
   http://localhost:8000
   ```

3. **디바이스 스캔:**
   - 상단 "🔄 스캔" 버튼 클릭
   - 3개 디바이스가 표시되는지 확인

4. **시뮬레이터 연결:**
   - IP: 192.168.1.200
   - 포트: 9000 (또는 실제 포트)
   - "🔌 연결" 버튼 클릭

---

## 문제 해결

### 피코4가 검색되지 않음

**원인 1: ADB 연결 끊김**
```cmd
adb disconnect
adb connect 192.168.1.101
```

**원인 2: Wi-Fi 연결 끊김**
- 피코4 Wi-Fi 상태 확인
- 공유기 재부팅

**원인 3: 방화벽 차단**
- Windows Defender 방화벽 일시 해제 후 테스트
- ADB 포트 5555 허용

### 시뮬레이터 연결 실패

**원인 1: IP 주소 불일치**
- 시뮬레이터 실제 IP 확인
- `config.py`의 `SIMULATOR_HOST` 수정

**원인 2: 포트 불일치**
- 시뮬레이터 통신 포트 확인
- `config.py`의 `SIMULATOR_PORT` 수정

**원인 3: 프로토콜 미구현**
- 현재 시뮬레이터 프로토콜이 정의되지 않음
- 제조사 프로토콜에 맞게 `simulator_controller.py` 수정 필요

### PC에서 피코4로 Ping 실패

**네트워크 격리 확인:**
- 공유기 AP Isolation 설정 확인
- 게스트 네트워크 사용 중인지 확인

**IP 주소 충돌:**
```cmd
arp -a
```
로 IP 충돌 확인

### ADB "unauthorized" 오류

1. 피코4에서 디버깅 허용 팝업 확인
2. "항상 이 컴퓨터에서 허용" 체크
3. "확인" 클릭

---

## 추가 팁

### 디바이스 라벨링

물리적으로 구분하기 쉽도록:
- 피코4 #1 (192.168.1.101) → 빨간색 스티커
- 피코4 #2 (192.168.1.102) → 파란색 스티커
- 피코4 #3 (192.168.1.103) → 초록색 스티커

### 자동 연결 스크립트

매번 ADB 연결하기 번거롭다면 배치 파일 생성:

**`adb_connect_all.bat`:**
```batch
@echo off
chcp 65001 >nul
echo 피코 디바이스 연결 중...
adb connect 192.168.1.101
adb connect 192.168.1.102
adb connect 192.168.1.103
echo.
echo 연결 상태:
adb devices
pause
```

### 네트워크 모니터링

원활한 연결을 위해 주기적으로:
```cmd
adb devices
ping -t 192.168.1.101
```

---

## 요약 체크리스트

설정 완료 후 확인:

- [ ] PC IP 주소: 192.168.1.100
- [ ] 피코4 #1: 192.168.1.101 고정 IP 설정
- [ ] 피코4 #2: 192.168.1.102 고정 IP 설정
- [ ] 피코4 #3: 192.168.1.103 고정 IP 설정
- [ ] 시뮬레이터: 192.168.1.200 IP 설정
- [ ] ADB 3대 연결 확인 (`adb devices`)
- [ ] PC → 모든 디바이스 ping 성공
- [ ] 방화벽 포트 8000, 9100 허용
- [ ] 컨트롤러 앱에서 디바이스 스캔 성공
- [ ] 시뮬레이터 프로토콜 확인 및 구현

---

## 문의

설정 중 문제가 발생하면:
1. 로그 파일 확인: `vr_controller.log`
2. 브라우저 개발자 도구 (F12) 콘솔 확인
3. 시뮬레이터 제조사 매뉴얼 참조
